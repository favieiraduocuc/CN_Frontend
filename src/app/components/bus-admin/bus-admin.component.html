<div class="dashboard-wrapper">
  <header class="top-bar">
    <div class="brand">
      <div class="logo">
        <span class="logo-icon">üöÜ</span>
        <div>
          <h1 class="system-title">BtrackUS</h1>
          <span class="system-status"
            ><span class="dot"></span>Administraci√≥n de Flota</span
          >
        </div>
      </div>
    </div>
    <div class="nav-links">
      <a (click)="goToDashboard()" class="nav-item">Dashboard</a>
    </div>
    <div class="user-actions">
      <div class="user-profile-container">
        <div class="user-profile" (click)="toggleProfile()">
          <div class="user-info">
            <span class="user-name">{{ fullName }}</span>
            <lucide-icon
              [img]="ChevronDownIcon"
              [class.rotated]="isProfileOpen"
            ></lucide-icon>
          </div>
          <img
            src="https://i.pravatar.cc/150?u=alex"
            alt="Profile"
            class="avatar"
          />
        </div>

        @if (isProfileOpen) {
          <div class="profile-dropdown">
            <div class="dropdown-header">{{ fullName }}</div>
            <button class="dropdown-item" (click)="logout()">
              <lucide-icon [img]="LogOutIcon"></lucide-icon>
              Cerrar Sesi√≥n
            </button>
          </div>
        }
      </div>
    </div>
  </header>

  <main class="main-content">
    <aside class="sidebar-left">
      <div class="header-section">
        <h2 class="section-title">UNIDADES REGISTRADAS</h2>
        <button
          class="btn-add-circle"
          (click)="resetForm()"
          title="Agregar Nuevo"
        >
          +
        </button>
      </div>

      <div class="search-box">
        <lucide-icon [img]="SearchIcon" class="icon-sm"></lucide-icon>
        <input
          type="text"
          placeholder="Filtrar por ID o ruta..."
          [(ngModel)]="searchQuery"
        />
      </div>

      <div class="lines-list">
        @for (bus of filteredBuses; track bus.id) {
          <div
            class="line-card"
            [class.selected]="busForm.get('id')?.value === bus.id"
            (click)="editBus(bus)"
          >
            <div class="line-icon-box">
              <lucide-icon [img]="BusIcon"></lucide-icon>
            </div>
            <div class="line-info">
              <span class="line-name">{{ bus.id }} - {{ bus.lineName }}</span>
              <span class="line-status" [ngClass]="bus.status"
                >‚óè {{ bus.status }}</span
              >
            </div>
            <lucide-icon
              [img]="ChevronRightIcon"
              class="arrow-icon"
            ></lucide-icon>
          </div>
        }
      </div>
    </aside>

    <section class="form-container">
      <div class="form-header">
        <h2>{{ isEditing ? "Editar Unidad" : "Nueva Unidad" }}</h2>
        <p>Todos los campos son obligatorios para el registro.</p>
      </div>

      <form [formGroup]="busForm" class="form-grid">
        <div class="input-group">
          <label>Patente</label>
          <input
            type="text"
            formControlName="plate"
            placeholder="Ej: ABC-123"
            [class.error]="
              busForm.get('plate')?.invalid && busForm.get('plate')?.touched
            "
          />
          @if (busForm.get("plate")?.invalid && busForm.get("plate")?.touched) {
            <span class="error-message"
              >Formato de patente inv√°lido (Ej: AA11-22)</span
            >
          }
        </div>

        <div class="input-group full-width">
          <label>Nombre de Ruta</label>
          <input
            type="text"
            formControlName="lineName"
            placeholder="Ej: Grecia / Maip√∫"
            [class.error]="
              busForm.get('lineName')?.invalid &&
              busForm.get('lineName')?.touched
            "
          />
          @if (
            busForm.get("lineName")?.invalid && busForm.get("lineName")?.touched
          ) {
            <span class="error-message"
              >Debe ingresar el nombre de la ruta</span
            >
          }
        </div>

        <div class="input-group full-width">
          <label>Estado de Operaci√≥n</label>
          <select
            formControlName="status"
            class="custom-select"
            [class.error]="
              busForm.get('status')?.invalid && busForm.get('status')?.touched
            "
          >
            <option value="ACTIVE">Activo</option>
            <option value="IN_SERVICE">En Servicio</option>
            <option value="MAINTENANCE">En Mantenimiento</option>
            <option value="OFFLINE">Fuera de Servicio</option>
          </select>
        </div>
      </form>

      <div class="form-actions">
        <button class="btn-secondary" (click)="resetForm()">Cancelar</button>
        <button class="btn-primary" (click)="saveBus()">
          <lucide-icon [img]="SaveIcon" class="icon-sm"></lucide-icon>
          {{ isEditing ? "Actualizar Cambios" : "Registrar Bus" }}
        </button>
      </div>
    </section>

    <aside class="sidebar-right">
      <h2 class="section-title">VISTA PREVIA</h2>

      <div class="preview-card">
        <div class="vehicle-header">
          <h3>{{ busForm.get("id")?.value || "---" }}</h3>
          <span class="status-badge" [ngClass]="busForm.get('status')?.value">
            {{ busForm.get("status")?.value }}
          </span>
        </div>
        <p class="preview-route">
          {{ busForm.get("lineName")?.value || "Sin ruta definida" }}
        </p>
        <small style="color: var(--text-secondary)"
          >Patente: {{ busForm.get("plate")?.value || "---" }}</small
        >
      </div>

      @if (isEditing) {
        <div class="danger-zone">
          <h3>Zona de Peligro</h3>
          <button
            class="btn-danger"
            (click)="deleteBus(busForm.get('id')?.value)"
          >
            <lucide-icon [img]="Trash2Icon" class="icon-sm"></lucide-icon>
            Eliminar Unidad
          </button>
        </div>
      }
    </aside>
  </main>
</div>
